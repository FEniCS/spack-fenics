name: ðŸ¤–

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * MON" # weekly, mondays 2am

jobs:
  style-check:
    name: âœ¨
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2
      - uses: actions/checkout@v5
        with:
          repository: spack/spack
          ref: develop
          path: spack-core
      - run: wget https://raw.githubusercontent.com/spack/spack-packages/refs/heads/develop/.github/workflows/requirements/style/requirements.txt
      - run: wget https://raw.githubusercontent.com/spack/spack-packages/refs/heads/develop/.flake8
      - run: wget https://raw.githubusercontent.com/spack/spack-packages/refs/heads/develop/.ci/style_check.sh
      - run: pip install -r requirements.txt
      - run: chmod +x style_check.sh
      - run: ./style_check.sh HEAD^
  # fenics-basix:
  #   runs-on: ubuntu-latest
  #   container: ubuntu:24.04
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       version: ["main", "0.10", "0.9", "0.8"]
  #       variant: ["build_type=Developer"]
  #       compiler: ["gcc@13", "clang@18"]
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         path: spack-fenics
  #     - uses: ./spack-fenics/.github/actions/test-package
  #       with:
  #         spec: fenics-basix@${{ matrix.version }} ${{ matrix.variant }} %${{ matrix.compiler }}

  # fenics-dolfinx:
  #   runs-on: ubuntu-latest
  #   container: ubuntu:24.04
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       version: ["main", "0.10", "0.9", "0.8"]
  #       variant: ["build_type=Developer", "partitioners=kahip,parmetis,scotch", "+petsc +slepc +adios2"]
  #       compiler: ["gcc@13", "clang@18"]
  #       exclude:
  #         # kahip does not support clang
  #         - variant: "partitioners=kahip,parmetis,scotch"
  #           compiler: "clang@18"
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         path: spack-fenics
  #     - uses: ./spack-fenics/.github/actions/test-package
  #       with:
  #         spec: fenics-dolfinx@${{ matrix.version }} ${{ matrix.variant }} %${{ matrix.compiler }}


  # fenics-ufcx:
  #   runs-on: ubuntu-latest
  #   container: ubuntu:24.04
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       version: ["main", "0.10", "0.9", "0.8"]
  #       compiler: ["gcc@13", "clang@18"]
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         path: spack-fenics
  #     - uses: ./spack-fenics/.github/actions/test-package
  #       with:
  #         spec: fenics-ufcx@${{ matrix.version }} %${{ matrix.compiler }}

  # py-fenics-basix:
  #   runs-on: ubuntu-latest
  #   container: ubuntu:24.04
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       version: ["main", "0.10", "0.9", "0.8"]
  #       compiler: ["gcc@13", "clang@18"]
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         path: spack-fenics
  #     - uses: ./spack-fenics/.github/actions/test-package
  #       with:
  #         spec: py-fenics-basix@${{ matrix.version }} %${{ matrix.compiler }}

  # py-fenics-dolfinx:
  #   runs-on: ubuntu-latest
  #   container: ubuntu:24.04
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       version: ["main", "0.10", "0.9", "0.8"]
  #       variant: ["build_type=Developer", "+petsc4py +slepc4py"]
  #       compiler: ["gcc@13", "clang@18"]
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         path: spack-fenics
  #     - uses: ./spack-fenics/.github/actions/test-package
  #       with:
  #         spec: py-fenics-dolfinx@${{ matrix.version }} ${{ matrix.variant }} %${{ matrix.compiler }}

  py-fenics-ffcx:
    needs: style-check
    runs-on: ubuntu-latest
    container: ubuntu:24.04
    strategy:
      fail-fast: false
      matrix:
        version: ["main", "0.10", "0.9", "0.8"]
    steps:
      - uses: actions/checkout@v5
        with:
          path: spack-fenics
      - uses: ./spack-fenics/.github/actions/test-package
        with:
          spec: py-fenics-ffcx@${{ matrix.version }}
      # workaround for https://github.com/spack/spack/issues/29447
      - name: Run tests
        shell: spack-bash {0}
        run: |
          spack env activate ./env
          spack install --log-format junit --log-file test-dep-log.xml --add py-pytest py-sympy py-pygraphviz
          spack stage py-fenics-ffcx@${{ matrix.version }}
          spack cd py-fenics-ffcx@${{ matrix.version }}
          pytest test/
      
      - name: Upload log
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.spec }}-test-dep-log
          path: test-dep-log.xml

  # py-fenics-ufl:
  #   needs: style-check
  #   runs-on: ubuntu-latest
  #   container: ubuntu:24.04
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       version: ["main", "2025.2", "2025.1", "2024.2", "2024.1"]
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         path: spack-fenics
  #     - uses: ./spack-fenics/.github/actions/test-package
  #       with:
  #         spec: py-fenics-ufl@${{ matrix.version }}
      
  #     # workaround for https://github.com/spack/spack/issues/29447
  #     - name: Run tests
  #       shell: spack-bash {0}
  #       run: |
  #         spack env activate ./env
  #         spack install --add py-pytest
  #         spack stage py-fenics-ufl@${{ matrix.version }}
  #         spack cd py-fenics-ufl@${{ matrix.version }}
  #         pytest test/
